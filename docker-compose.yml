services:
  # Run with: docker compose run --rm linux-snow-export
  linux-snow-export:
    build:
      context: .
      target: export
    command:
      - /bin/sh
      - -c
      - |
        set -e
        ver="snow-v${SNOW_VERSION}-linux-x64"
        mkdir -p "/output/release/$$ver/bin"
        # 覆盖旧的可执行文件，避免第二次运行时 File exists
        cp -f /export/snow "/output/release/$$ver/bin/snow"
        if [ -d /export/lib ]; then
          mkdir -p "/output/release/$$ver/lib"
          cp -a /export/lib/. "/output/release/$$ver/lib/"
        fi
        tar -C /output/release -czf "/output/release/$$ver.tgz" "$$ver"
    volumes:
      - ./target:/output
      - ./lib:/export/lib:ro
    env_file:
      - .env
