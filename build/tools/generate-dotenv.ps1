# build\tools\generate-dotenv.ps1

# Repository root: go up two levels from build\tools\
$repoRoot = (Get-Item $PSScriptRoot).Parent.Parent.FullName
$envPath  = Join-Path $repoRoot ".env"
$mvnConfigPath = Join-Path $repoRoot ".mvn\maven.config"

if (-not (Test-Path $mvnConfigPath -PathType Leaf)) {
    throw "maven.config not found: $mvnConfigPath"
}

# Read the line containing -Dsnow.version=xxx from maven.config
$mvnLines = Get-Content $mvnConfigPath -Encoding UTF8
$versionLine = $mvnLines | Where-Object { $_ -match "^-Dsnow\.version=" }

if (-not $versionLine) {
    throw "snow.version not found in maven.config"
}

# Extract the value after the equals sign
$version = $versionLine -replace "^-Dsnow\.version=", ""

# Write to .env
$lines = @(
    "# Auto-generated by build\tools\generate-dotenv.ps1"
    "SNOW_VERSION=$version"
)

$utf8NoBom = New-Object System.Text.UTF8Encoding($false)
[System.IO.File]::WriteAllLines($envPath, $lines, $utf8NoBom)
Write-Host "Generated/overwritten $envPath (version: $version)"
return